# 6.1~5 안정적인 운영을 완성하는 모니터링, 프로메테우스와 그라파나

이번 챕터는 실습이 거의 90퍼 이상을 차지하고 있기 때문에 실습내용을 제외한 이론적인 부분만 다루려고 했습니다. 따라서 책의 분량은 많지만 요약한 내용은 그다지 많지가 않았습니다.

### 모니터링 단계

수집 → 통합 → 시각화

프로메테우스    그라파나

### 여러가지 데이터 수집 및 통합 도구 요약

| 구분 | 프로메테우스 | 데이터독 | 뉴 렐릭 | 인플럭스db |
| --- | --- | --- | --- | --- |
| 가격 | 무료 | 유료 | 유료 | 유/무료 |
| 형태 | 설치형 | 서비스 형 | 서비스 형 | 서비스 형/설치형 |
| 참고자료 | 매우 많음 | 많음 | 많음 | 많음 |
| 기능 확장성 | 매우 좋음 | 좋음 | 좋음 | 좋음 |

### 여러가지 시각화 도구 요약

| 구분 | 그라파나 | 키바나 | 크로노그래프 |
| --- | --- | --- | --- |
| 가격 | 유/무료 | 유/무료 | 유/무료 |
| 형태 | 서비스형/설치형 | 서비스형/설치형 | 서비스형/설치형 |
| 시각화 대상 | 다양한 대상 시각화 기능 | 앨라스틱서치 | 인플럭스 db |
| 정보량 | 많음 | 많음 | 적음 |
| 기능 확장성 | 좋음 | 좋음 | 적음 |

### 리소스 매트릭 파이프라인

![https://user-images.githubusercontent.com/15958325/77894469-483d2a00-72b0-11ea-8aaf-dc8a8bcb07fc.png](https://user-images.githubusercontent.com/15958325/77894469-483d2a00-72b0-11ea-8aaf-dc8a8bcb07fc.png)

출처 :[https://user-images.githubusercontent.com/15958325/77894469-483d2a00-72b0-11ea-8aaf-dc8a8bcb07fc.png](https://user-images.githubusercontent.com/15958325/77894469-483d2a00-72b0-11ea-8aaf-dc8a8bcb07fc.png)

매트릭 cAdvisor가 컨테어나의 매트릭 정보를 수집하고 이를 매트릭 서버로 보냅니다.

이후 매트릭 api를 통해서 수집된 정보로 여러 기능을 구현할 수 있습니다. 

다만 이때 정보들은 저장되는 것이 아니기 때문에 현재의 상태만을 알 수 있습니다.

따라서 수집한 데이터를 따로 저장 공간에 저장하는 **완전한 모니터링 파이프라인**을 구축하기를 권장한다고 책에 적혀있습니다. 

## 6.2 프로메테우스 모니터링 데이터 수집과 통합하기

### 프로메테우스 서버

하는 일

- 노드 익스포터외 여러 대상에서 공개된 매트릭을 수집해 오는 수집기
- 수집한 시계열 메트릭 데이터를 저장하는 시계열 db
- 저장된 데이터를 질의하거나 수집 대상의 상태를 확인 할 수 있는 웹 ui

### 노드 익스포터

: 노드 시스템 메트릭 정보를 http로 공개하는 역할

### 쿠버 스테이트 매트릭

: api 서버로 쿠버네티스 클러스터의 여러 메트릭 데이터를 수집한 후, 이를 프로메테우스 서버가 수집할 수 있는 메트릭 데이터로 변환해 공개하는 역할

### 얼럿매니저

: 프로메테우스에 경보 규칙을 설정하고, 경보 이벤트가 발생하면 설정된 경보 메시지를 대상에게 전달하는 기능을 제공

### 푸시 게이트웨이

: 배치와 스케줄 작업시 수행되는 일회성 작업들의 상태를 저장하고 모아서 프로메테우스가 주기적으로 가져갈 수 있도록 공개

## 6.2.3 서비스 디스커버리로 수집대상 가져오기

프로메테우스는 수집대상을 자동으로 인식하고 필요한 정보를 수집

→ 프로메테우스 서버가 정보를 가져오는 방식이 서비스 디스커버리 이기 때문

1. 프로메테우스 서버는 컨피그 맵에 기록된 내용을 바탕으로 대상을 읽어옵니다
2. 읽어온 대상에 대한 매트릭을 가져오기 위해 api 서버에 정보를 요청
3. 요청을 통해 알아온 경로로 메트릭 데이터를 수집

서비스 디스커버리 방법은 대상에 따라 2가지로 나뉩니다.

- cAdvisor

: 쿠버네티스 api 서버에 직접 연결돼 메트릭을 수집한다.

- 에이전트(익스포터)

: api서버가 경로를 알려주어 메트릭 을 수집한다.

## 6.2.4 노드 익스포터로 쿠버네티스 노드 메트릭 수집하기

노드 익스포터는 익스포터들 중에서도 쿠버네티스 노드의 상태 값을 메트릭으로 추출하는 데 특화돼 있습니다.

노드의 /proc ,/sys에 있는 값을 메트릭으로 노출하도록 구현돼 있습니다.

/proc : 리눅스 운영 체제에서 구동중인 프로세스들의 정보를 파일 시스템 형태로 연결한 디렉터리입니다.

/sys : 저장 장치, 네트워크 장치, 입출력 장치 같은 각종 장치를 운영체제에서 사용 할 수 있도록 파일 시스템 형태로 연결한 디렉터리입니다.

## 6.2.5 쿠버 스테이트 메트릭으로 쿠버네티스 노드 메트릭 수집하기

api 서버에서 이미 수집된 정보를 가져와서 사용합니다. 각 노드의 특정 디렉터리를 마운트해서 사용하는 노드 익스포터와 달리 이미 수집된 정보를 사용한다는게 특징입니다.

## 6.3 메트릭 데이터 구조

메트릭에 대한 간단한 설명은 다음과 같습니다.

> 대부분의 경우 메트릭은 HTTP 서버의 `/metrics`
 엔드포인트에서 사용할 수 있다. 기본적으로 엔드포인트를 노출하지 않는 컴포넌트의 경우 `--bind-address`
 플래그를 사용하여 활성화할 수 있다.
> 

### 종류

- 카운터 : 누락된 값을 표현하는 데 사용하는 메트릭타입, 구간별로 변화율을 파악해 해당 값이 어느정도 추세로 증가하는 지 알 수 있습니다.
- 게이지 : 특정 시점의 값을 표현하는 데 사용하는 메트릭 타입입니다.., 카운터의 특징 구현할 수 있을 뿐 아니라 시점별로 증가나 감소를 모두 표현 가능합니다.
- 히스토그램 : 사전에 미리 정의한 구간 안에 있는 메트릭 값의 빈도를 측정합니다.이때 익스포터를 구현하는 단계에서 정의 한 구간을 버킷이라고 합니다.
- 서머리 : 히스토그램과 비슷하게 구간내에 있는 메트릭 값의 빈도를 측정합니다.

### 레이블

모든  메트릭은 하나 이상의 레이블을 가집니다. 이때 레이블은 key-value형태로 넣습니다. 이렇게 넣은 다수의 레이블은 관리자는 마음대로 검색 및 추출 할 수 있습니다.

---

메트릭에 대해 조사하던 도중 공식문서에서 메트릭에 대한 자세한 내용을 좀더 찾을 수 있었습니다

### 생명주기

알파(Alpha) 메트릭 → 안정적인(Stable) 메트릭 → 사용 중단된(Deprecated) 메트릭 → 히든(Hidden) 메트릭 → 삭제된(Deleted) 메트릭

알파 메트릭은 불안전한 상태로 언제든지 수정 및 삭제될 수 있는 상태라고 합니다. 

안정적인 메트릭은 변경되지 않는 것을 보장하여 안정적인 상태입니다. 

출처:[https://kubernetes.io/ko/docs/concepts/cluster-administration/system-metrics/](https://kubernetes.io/ko/docs/concepts/cluster-administration/system-metrics/)

사실 책에서는 뒤에 그라파나에 대한 실습이 있었는데 내용이 거의 100퍼센트 실습 중심이였고 필자는 실습을 제대로 진행하지 못하여서 구체적인 내용을 적을 수 없었습니다.