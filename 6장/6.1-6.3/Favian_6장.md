## 6장 : 안정적인 운영을 완성하는 모니터링, 프로메테우스와 그라파나

젠킨스로 쿠버네티스 애플리케이션 빌드와 배포를 자동화해 컨테이너 환경에 배포된 애플리케이션은 충분히 검증을 거친 상태지만,

상용 환경에서는 여러 가지 예외 상황이 발생할 수 있습니다

예를 들어 노드에서 하드웨어적으로 문제가 생기거나 컨테이너 관점에서 가용하는 리소스보다 많은 요청이 발생해 문제가 생기는 경우가 있을 수 있습니다

이를 위해 구축한 환경 자체를 모니터링하고, 문제가 생길 경우 적절한 조치를 빠르게 취해야 합니다

## 6.1 : 컨테이너 인프라 환경 모니터링하기

```shell
> bpytop : 시스템 상태 정보 조회

리소스의 상태 및 문제가 될 가능성이 있는 정보를 한눈에 파악

하지만, bpytop은 현재 노드에 대한 정보를 보여줄 뿐, 다수의 노드로 구성된 클러스터 정보를 모두 표현하기에는 한계가 있습니다
이러한 정보를 수집하고 분류해서 따로 저장해야 합니다

모니터링 도구는 수집 -> 통합 -> 시각화 구조로 되어 있습니다
```

모니터링 데이터를 프로메테우스로 **수집**하고 수집한 정보를 한곳에 모아(**통합**), 그라파나로 **시각화**합니다

### 6.1.1 : 모니터링 도구 선택하기

프로메테우스와 그라파나의 혼합 구조를 사용하는 이유는 크게 2가지 입니다

- 비용

모니터링 대상마다 라이선스 관련 비용이 발생하고, 클라우드 같은 과금제 서비스를 이용하면 네트워크와 저장 공간에 따른 추가 비용이 발생합니다

그래서 비용에 민감한 조직에는 도입하기 어렵습니다

- 보안

서비스형 모니터링 도구들은 대부분 외부에 데이터를 저장해 모니터링합니다

보안에 민감해서 내부에서 모든 데이터를 처리하려는 경우에는 사용하기 어렵습니다

#### 데이터 수집과 통합 도구

| 구분       | 프로메테우스 | 데이터독  | 뉴 렐릭 | 인플럭스DB   |
|----------|--------|-------|------|----------|
| 가격       | 무료     | 유료    | 유료   | 유/무료     |
| 형태       | 설치형    | 서비스형  | 서비스형 | 서비스형/설치형 |
| 참고 자료    | 매우 많음  | 많음  | 많음   | 많음       |
| 기능 확장성 | 매우 좋음  | 좋음 | 좋음   | 좋음         |

```shell
메트릭이란?

시스템의 상태를 알 수 있는 '측정값'

시스템 메트릭 : CPU와 메모리 사용량을 나타냄
서비스 메트릭 : HTTP 상태 코드 같은 서비스 상태를 나타내는 지표

시계열 데이터베이스란?

시간을 축으로 시간의 흐름에 따라 발생하는 데이터를 저장하는 데 최적화된 데이터베이스
```

#### 데이터 시각화 도구

| 구분     | 그라파나        | 키바나      | 크로노그래프   |
|--------|-------------|----------|----------|
| 가격     | 유/무료        | 유/무료     | 유/무료     |
| 형태     | 서비스형/설치형    | 서비스형/설치형 | 서비스형/설치형 |
| 시각화 대상 | 다양한 대상 시각화 가능 | 엘라스틱서치   | 인플럭스DB   | 
| 정보량    | 많음        | 많음       | 적음       |
| 기능 확장성 | 좋음        | 좋음       | 적음       |

### 6.1.2 : 쿠버네티스 환경에 적합한 모니터링 데이터 수집 방법

쿠버네티스 노드는 kubelet을 통해 파드를 관리, 파드의 cpu나 메모리 같은 메트릭 정보를 수집하기 위해

kubelet에 내장된 cAdvisor를 사용합니다.

> cAdvisor : 구글이 만든 컨테이너 메트릭 수집 도구

cAdvisor로 수집되고 kubelet으로 공개되는 데이터가 있어도 외부에서 이를 모아서 표현해 주는 도구가 없다면 의미가 없습니다

메트릭 서버에서 수집한 데이터로 여러 기능을 수행하도록 구성한 것을 **리소스 메트릭 파이프라인**이라고 합니다

메트릭 서버는 집계한 데이터를 메모리에만 저장하므로 데이터를 영구적으로 보존하기 어렵고 현재 시점의 데이터만 출력합니다

그래서 메트릭 데이터를 저장 공간에 따로 저장하는 **완전한 모니터링 파이프라인**으로 구축하기를 권장합니다

**완전한 모니터링 파이프라인**으로 구성한 프로메테우스는 여러 메트릭 데이터를 모아 시계열 데이터베이스에 저장합니다

누적된 메트릭 데이터로 쿠버네티스 인프라의 상태 변화를 파악할 수 있고, 적절한 위험 감지 및 조치를 취할 수 있습니다

## 6.2 : 프로메테우스로 모니터링 데이터 수집과 통합하기

- 프로메테우스 서버

프로메테우스의 주요 기능을 수행하는 요소 (3가지 역할)

1. 노드 익스포터 외 여러 대상에서 공개된 메트릭을 수집해 오는 수집기

2. 수집한 시계열 메트릭 데이터를 저장하는 시게열 데이터베이스

3. 저장된 데이터를 질의하거나 수집 대상의 상태를 확인할 수 있는 웹 UI

- 노드 익스포터

노드의 시스템 메트릭 정보를 HTTP로 공개하는 역할을 합니다

설치된 노드에서 특정 파일들을 읽고, 이를 프로메테우스 서버가 수집할 수 있는 메트릭 데이터로 변환한 후에 노드 익스포터에서 HTTP 서버로 공개합니다

- 쿠버 스테이트 메트릭

API 서버로 쿠버네티스 클러스터의 여러 메트릭 데이터를 수집한 후, 이를 프로메테우스 서버가 수집할 수 있는 메트릭 데이터로 변환해 공개하는 역할을 합니다

- 얼럿매니저(alertmanager)

프로메테우스에 경보 규칙을 설정하고, 경보 이벤트가 발생하면 설정된 경보 메시지를 대상에게 전달하는 기능을 제공합니다

프로메테우스에 설치하면 프로메테우스 서버에서 주기적으로 경보를 보낼 대상을 감시해 시스템을 안정적으로 운영할 수 있게 합니다

- 푸시게이트웨이

배치와 스케줄 작업 시 수행되는 일회성 작업들의 상태를 저장하고 모아서 프로메테우스가 주기적으로 가져갈 수 있도록 공개합니다

일반적으로 짧은 시간 동안 실행되고 종료되는 배치성 프로그램의 메트릭을 저장하거나 외부망에서 접근할 수 없는 내부 시스템의 메트릭을 프록시 형태로 제공하는 용도로 사용합니다

### 6.2.3 : 서비스 디스커버리로 수집 대상 가져오기

프로메테우스는 수집 대상을 자동으로 인식하고 필요한 정보를 수집합니다

정보를 수집하려면 일반적으로 에이전트를 설정해야 하지만, 쿠버네티스는 사용자가 에이전트에 추가로 입력할 필요 없이 자동으로 메트릭을 수집할 수 있습니다

이는 프로메테우스 서버가 수집 대상을 가져오는 방법인 **서비스 디스커버리** 덕분입니다

- 작동 순서

1. 프로메테우스 서버는 컨피그맵에 기록된 내용을 바탕으로 대상을 읽어옵니다

2. 읽어온 대상에 대한 메트릭을 가져오기 위해 API 서버에 정보를 요청합니다

3. 요청을 통해 알아온 경로로 메트릭 데이터를 수집합니다

이와 같은 순서로 프로메테우스 서버와 API 서버가 주기적으로 데이터를 주고받아 수집 대상을 업데이트하고, 수집 대상에서 공개되는 메트릭을 자동으로 수집합니다

쿠버네티스 API 서버에 직접 연결돼 메트릭을 수집하는 cAdvisor과 API 서버가 경로를 알려 주어 메트릭을 수집할 수 있는 에이전트입니다

프로메테우스에서 에이전트는 보통 익스포터라 합니다

#### cAdvisor

cAdvisor의 메트릭이 API 서버를 통해 노출되면 프로메테우스 서버가 쉽게 수집하도록 변환하는 과정을 거칩니다

#### 익스포터

서비스 디스커버리에서 수집은 자동으로 이뤄지지만, 익스포터는 사전 준비 작업 2가지를 해야 합니다

1. API 서버에서 등록돼 경로를 알 수 있게 해야 합니다

2. 익스포터가 데이터를 프로메테우스 타입으로 노출해야 합니다

```yaml
멀티 컨테이너 패턴

파드 내부에 컨테이너 여러 개를 구성하는 방법

- 사이드카 : 메인 컨테이너의 기능을 확장하거나 기능을 향상하고자 할 때 추가하는 패턴

- 앰버서더 : 사용자가 외부에서 접근할 때 앱배서더 컨테이너를 통해 통신이 이루어지는 형태로, 세부적인 외부 접근 대상이나 방법은
            앱버서더 컨테이너에 위임합니다. 주로 프록시 컨테이너를 구성해 외부의 접근을 제어하고 내부 자원을 보호하는 구성이 앰배서더 패턴에 속합니다

- 어댑터 : 메인 컨테이너의 정보를 외부에서 사용할 수 있는 형식으로 변환하는 컨테이너가 추가된 형태
```

## 6.3 : PromQL로 메트릭 데이터 추출하기

현업에서는 수집된 메트릭 데이터를 그대로 사용하기보다는 필요한 메트릭 데이터를 다시 한 번 가공해서 추출하는 경우가 더 많습니다

필요한 메트릭 데이터를 정확하게 추출하려면 PromQL을 알아야 합니다

### 6.3.1 : 메트릭 데이터의 구조

#### 메트릭 값의 종류

- 카운터 : 누적된 값을 표현하는 데 사용하는 메트릭 타입입니다

카운터에 누적된 값으로 구간별로 변화율을 파악해 해당 값이 어느 정도 추세로 증가하는지 알 수 있습니다

> 이벤트나 오류 등이 급증하는 구간을 파악하는 데 적합

값이 누적되기 때문에 특정 순간의 데이터를 표현하는 데는 적합하지 않습니다

- 게이지 : 특정 시점의 값을 표현하는 데 사용하는 메트릭 타입

카운터가 누적된 값을 표현해 증가만을 고려하는 것과 달리 게이지는 시점별로 증가나 감소를 모두 표현할 수 있습니다

CPU 온도나 메모리 사용량 등은 누적된 값이 필요하지 않고 조회하는 순간의 값이 중요하므로 게이지 타입을 사용합니다

- 히스토그램 : 사전에 미리 정의한 구간 안에 있는 메트릭 값의 빈도를 측정합니다

> 익스포터를 구현하는 단계에서 정의한 구간을 **버킷**이라고 합니다

- 서머리 : 히스토그램과 비슷하게 구간 내에 있는 메트릭 값의 빈도를 측정합니다

> 클라이언트 요청에 따른 응답 시간을 관측하고 저장할 때 사용할 수 있습니다

#### 메트릭 레이블

모든 메트릭 데이터는 하나 이상의 레이블을 가집니다

프로메테우스의 레이블은 일반적인 주석이 아니라 메트릭 데이터의 다양한 내용을 표현하는 유일한 방법입니다

단순히 1~2개의 레이블이 아니라 제공하고 싶은 다수의내용을 key-value 형태로 넣습니다

#### 메트릭 레이블 매처

- 메트릭 레이블에 조건을 줘서 검색하는 방법

레이블 매처는 레이블이 존재하면 그에 해당하는 메트릭 데이터를 추출합니다

조건 기호

- =: 조건에 넣은 값과 레이블 값이 같은 메트릭을 보여줍니다

- !=: 조건에 넣은 값과 레이블 값이 다른 메트릭을 보여줍니다

- =~: 조건에 넣은 정규 표현식에 해당하는 메트릭을 보여줍니다

- !~: 조건에 넣은 정규 표현식에 해당하지 않는 메트릭을 보여줍니다



### .3.2 젠킨스 살펴보기

젠킨스 컨트롤러가 단독으로 설치할 경우에는 컨트롤러가 설치된 서버에서

젠킨스 자체 시스템 관리, CI/CD 설정, 빌드 등의 작업을 모두 젠킨스 컨트롤러 단일 녿에서 수행합니다

컨트롤러-에이전트 구조로 설치할 경우 컨트롤러는 젠킨스 자체의 관리 및 CI/CD와 관련된 설정만을 담당하고 실제 빌드 작업은 에이전트로 설정된 노드에서 이루어집니다

### 5.3.4 : 젠킨스 에이전트 설정하기

쿠버네티스의 역할 부여 구조는 **할 수 있는 일**(무엇을 할 수 있나?)과 **할 수 있는 주체**(누가 할 수 있나?)의 결합으로 이루어집니다

- Rules

역할 기반 접근 제어에서 '할 수 있는 일'과 관련된 Role, ClusterRole이 가지고 있는 자세한 행동 규칙입니다

특정 API를 통해서 어떠한 자원에 접근해 목록이나 정보를 조회하거나 자원을 생성, 삭제, 수정하는 등의 행위를 하는 것을 의미합니다

- Role, ClusterRole

'할 수 있는 일'을 대표하는 오브젝트입니다

Rules에 적용된 규칙에 따른 동작을 할 수 있으며 적용 범위에 따라 Role과 ClusterRole로 나뉩니다

Role은 해당 Role을 가진 주체가 특정 namespace 에 대해서 접근할 수 있습니다

ClusterRole은 해당 ClusterRole을 가진 주체가 쿠버네티스 클러스터 전체에 대해서 접근할 수 있도록 합니다

- RoleBinding, ClusterRoleBinding

'무엇을 할 수 있나?' 라는 속성을 '할 수 있는 주체' 속성의 Subjects와 연결시켜주는 역할을 합니다

RoleBinding은 앞에서 설명한 Role과 결합하여 네임스페이스 범위의 접근 제어를 수행합니다

ClusterRoleBinding은 ClusterRole과 결합해 클러스터 전체 범위의 접근 제어를 수행합니다

- Subjects

행위를 수행하는 주체를 의미합니다

Subjects는 특정 사용자 혹은 그룹, 서비스 어카운트를 속성으로 가질 수 있습니다

쿠버네티스 클러스터에 등록된 사용자의 목록은 kubeconfig의 users 섹션에 기록돼 있습니다

파드는 네임스페이스에 존재하는 default 서비스 어카운트를 사용하거나 특정한 서비스 어카운트를 사용하도록 설정할 수 있으며

파드 내부의 프로세스는 설정된 서비스 어카운트로서 쿠버네티스상에 존재하는 자원에 접근을 시도할 수 있습니다