# 모니터링

거의 모든 모니터링 도구는 `수집 → 통합 → 시각화` 구조로 돼 있습니다.

컨테이너 인프라 환경에서는 데이터를 프로메테우스로 수집하고, 수집한 정보를 한 곳에 모아 그라파나로 시각화한다.

### 모니터링 도구 선택하기

프로메테우스와 그라파나는 오픈소스 도구인데, 오픈 소스는 가능한 한 단일 도구에서 단일 기능만을 구현하는 것을 선호한다. 

모든 기능을 모아둔 하나의 도구를 사용하지 않고 프로메테우스+그라파나와 같은 혼합 구조를 사용하는 이유는

- 비용 : 모니터링 대상마다 라이선스 관련한 비용이 발생하고, 클라우드 같은 과금제 서비스를 이용하면 네트워크와 저장 공간에 따른 추가 비용이 발생한다. ex) 데이터독, 뉴렐릭은 모니터링 대상마다 비용 부과
- 보안 : 서비스형 모니터링 도구들은 대부분 외부에 데이터를 저장해 모니터링하는데, 보안에 민감하여 내부에서 모든 데이터를 처리하는 경우엔 서비스형 모니터링 도구를 사용하기 어렵다.

## 쿠버네티스 환경에서 모니터링

쿠버네티스는 노드는 kubelet을 통해 파드를 관리하며, 파드의 CPU나 메모리같은 메트릭 정보를 수집하기 위해 kubelet에 내장된 cAdvisor를 사용한다. 

cAdvisor는 구글이 만든 커네팅너 매트릭 수집 도구로, 쿠버네티스 클러스터 위에 배포된 여러 컨테이너가 사용하는 메트릭 정보를 수집한 후 이를 가공해서 kubelet에 전달하는 역할을 한다.

- cAdvisor로 수집하고, kubelet으로 공개되는 데이터가 있어도 외부에서 이를 모아서 표현해주는 도구가 없다면 의미가 없다.

### 리소스 메트릭 파이프라인

메트릭 서버에서 수집한 데이터로 여러 기능을 수행하도록 구성한 것

- 문제점 : 메트릭 서버는 집계한 데이터를 메모리에만 저장하므로 데이터를 영구적으로 보존하기 어렵고, 현재 시점의 데이터만 출력된다.

### 완전한 모니터링 파이프라인

메트릭 데이터를 저장 공간에 따로 저장하는 방식

- 위의 일시적인 집계 데이터 문제를 해결한다.
- 완전한 모니터링 파이프라인으로 구성한 프로메테우스는 여러 수집 대상이 공개하는 메트릭 데이터를 모아 시계열 데이터베이스에 저장한다.
- 누적된 메트릭 데이터로는 쿠버네티스 인프라의 상태 변화를 파악할 수 있고, 적절한 위험 감지 및 조치를 취할 수 있다.

# 프로메테우스

### 프로메테우스 서버 (prometheus server)

프로메테우스의 주요 기능을 수행하는 요소

[ 프로메테우스 서버의 3가지 역할 ]

1. 수집기 : 노드 익스포터 외 여러 대상에서 공개된 메트릭을 수집한다.
→ ‘서비스 디스커버리’라는 방법을 통해 수집 대상을 찾는다.
2. 시계열 데이터베이스 : 수집한 시계열 메트릭 데이터를 저장한다.
3. 웹 UI : 저장된 데이터를 질의하거나 수집 대상의 상태를 확인한다.

### 노드 익스포터 (node-exporter)

노드의 시스템 메트릭 정보를 HTTP로 공개하는 역할

- 설치된 노드에서 특정 파일들을 읽고, 이를 프로메테우스 서버가 수집할 수 있는 메트릭 데이터로 변환한 후에 노드 익스포터에서 HTTP 서버로 공개한다.
- 공개된 내용을 프로메테우스 서버에서 수집해간다.

### 쿠버 스테이트 메트릭 (kube-state-metric)

API서버로 쿠버네티스 클러스터의 여러 메트릭 데이터를 수집한 후, 이를 프로메테우스 서버가 수집할 수 있는 메트릭 데이터로 변환해 공개하는 역할

- 쿠버 스테이트 메트릭 덕분에 프로메테우스가 쿠버네티스 클러스터의 여러 정보를 쉽게 획득할 수 있다.

### 얼럿 매니저 (alert manager)

프로메테우스에 경보 규칙을 설정하고, 경보 이벤트가 발생하면 설정된 경보 메시지를 대상에게 전달한다.

### 푸시게이트웨이 (pushgateway)

배치와 스케줄 작업 시 수행되는 일회성 작업들의 상태를 저장하고 모아서 프로메테우스가 주기적으로 가져갈 수 있도록 공개한다.

# 서비스 디스커버리

프로메테우스는 수집 대상을 자동으로 인식하고 필요한 정보를 수집한다.

정보를 수집하려면 일반적으로 에이전트를 설정해야 하지만, 쿠버네티스는 사용자가 에이전트에 추가로 입력할 필요 없이 자동으로 메트릭을 설정할 수 있다. 

### 서비스 디스커버리 동작 순서

1. 프로메테우스 서버는 컨피그맵에 기록된 내용을 바탕으로 대상을 읽어온다.
2. 읽어온 대상에 대한 메트릭을 가져오기 위해 API 서버에 정보를 요청한다.
3. 요청을 통해 알아온 경로로 메트릭 데이터를 수집한다.

→ 프로메테우스 서버와 API 서버가 주기적으로 데이터를 주고받아 수집 대상을 업데이트하고, 수집 대상에서 공개되는 메트릭을 자동으로 수집한다.

## 서비스 디스커버리를 위한 2가지 경로

서비스 디스커버리 방법은 대상에 따라 크게 2가지 경로로 나뉜다.

1. cAdvisor : 쿠버네티스 API에 직접 연결돼 메트릭을 수집하는 cAdvisor 방법
2. 익스포터(에이전트) : API 서버가 경로를 알려주어 메트릭을 수집할 수 있는 익스포터(에이전트) 방법

### cAdvisor

cAdvisor의 메트릭이 API 서버를 통해 노출되면 프로메테우스 서버가 쉽게 수집하도록 변환하는 과정을 거친다.

- 새롭게 배포되는 디플로이먼트가 있으면 이를 configmap에 수집 대상으로 지정하여 자동으로 메트릭이 수집된다.
→ 배포된 deployment를 삭제한다고 configmap에 있던 수집 대상 지정 데이터가 사라지진 않는다.
- cAdvisor는 각 노드에 컨테이너 시스템 정보를 담고 있는 특정 파일들을 읽어들여 메트릭을 수집하고, 프로메테우스가 수집할 수 있도록 컨테이너 메트릭을 프로메테우스의 메트릭으로 변환해 공개한다.

### 익스포터

서비스 디스커버리에서 수집은 자동으로 이뤄지지만, 익스포터는 2가지 사전 작업을 해야한다.

[ 익스포터 2가지 사전 작업 ]

1. API 서버에서 등록돼 경로를 알 수 있게 해야 한다.
2. 익스포터가 데이터를 프로메테우스 타입으로 노출해야 한다.

[ 어노테이션 설정 ]

어노테이션 : 소스 코드에 주석으로 추가되는 메타데이터로, 여러 어플리케이션이나 다른 도구에 정보를 전달하는 역할을 한다. 

- 프로메테우스 서버가 배포된 어플리케이션을 API 서버에서 찾아 메트릭을 수집하려면 어노테이션 설정이 가장 중요하다.
- 어노테이션을 이용해 수집 대상을 판별하고 경로를 재조합한다.

```
# nginx deployment 배포
kubectl apply -f ~/_Book_k8sInfra/.../nginx-status-annot.yaml
```

nginx 디플로이먼트를 배포해도, 메트릭은 수집되지 않는다.
→ 이는 메트릭이 공개되지 않았기 때문이다.

[ 프로메테우스에서 메트릭을 공개하는 2가지 방법 ]

1. 프로그래밍 언어의 프로메테우스 SDK를 사용해 직접 메트릭을 공개하도록 작성하는 방법
2. 미리 만들어 둔 익스포터를 사용해 메트릭을 공개하는 방법

```
# 익스포터 배포 -> 컨테이너로부터 메트릭을 받아 공개할 수 있게 됨
kubectl apply -f ~/_Book_k8sInfra/.../nginx-status-metrics.yaml
```

여기서는 미리 만들어 둔 익스포터를 사용하여 메트릭을 공개한다.

배포한 nginx에서 제공하는 nginx-prometheus-exporter 익스포터를 사이드카 패턴으로 배포하여 컨테이너로부터 받은 메트릭을 공개할 수 있도록 한다.

[ 멀티 컨테이너 패턴 ]

- 사이드카 : 메인 컨테이너의 기능을 확장하거나 기능을 향상하고자 할 때 추가하는 패턴
- 앰배서더 : 사용자가 외부에서 접근할 때 앰배서더 컨테이너를 통해 통신이 이루어지는 형태.
→ 세부적인 외부 접근 대상이나 방법은 앰배서더 컨테이너에 위임한다. 
→ 주로 프록시 컨테이너를 구성해 외부의 접근을 제어하고 내부 자원을 보호하는 구성이다.
- 어댑터 : 메인 컨테이너의 정보를 외부에서 사용할 수 있는 형식으로 변환하는 컨테이너가 추가된 형태

[ 다양한 종류의 프로메테우스 익스포터 ]

프로메테우스는 대상을 모니터링하기 위해 다양한 형태의 익스포터를 사용한다.

| 분야 | 데이터베이스 | 메시징 시스템 | 스토리지 | 외부 모니터링 시스템 |
| --- | --- | --- | --- | --- |
| 주요 관심사 | 안정성 지표, 내부 구조 | 처리량, 전달 성공률 | 사용량 | 외부 시스템 통합 |
| 대표적 수집 대상 | ElasticSearch, MongoDB, MySQL, Oracle | Kafka, RabbitMQ, NATS | Ceph, Gluster, GPFS | AWS CloudWatch, Google Stackdriver, Azure Monitor |

## 노드 익스포터로 쿠버네티스 노드 메트릭 수집하기

노드 익스포터는 쿠버네티스 노드의 상태 값을 메트릭으로 추출하는 데 특화되어 있다. 

- 노드 익스포터는 각 노드(마스터, 워커)에 있는 `/prod` 과 `/sys` 에 있는 값을 메트릭으로 노출하도록 구현돼 있다. (각 노드의 /proc, /sys 디렉토리를 마운트해서 사용한다.)
- `/proc` : 리눅스 운영 체제에서 구동 중인 프로세스들의 정보를 파일 시스템 형태로 연결한 디렉토리. 디렉토리 안에는 현재 구동중인 프로세스들의 프로세스 id가 디렉토리 형태로 나타나며, 각 디렉토리 내부에 해당 프로세스에 대한 상태나 실행 환경에 대한 정보가 들어있다.
→ 모니터링 도구는 구동중인 프로세스의 **정보나 상태, 자원 사용량** 등을 알 수 있다.
- `/sys` :  저장 장치, 네트워크 장치, 입출력 장치 같은 각종 장치를 운영 체제에서 사용할 수 있도록 파일 시스템 형태로 연결한 디렉토리. 이 디렉토리 내부에 있는 파일들을 분석하면 전체 장치의 상태를 알 수 있다.
→ 모니터링 도구는 **시스템 장치의 상태 정보**를 알 수 있다.

→ 노드 익스포터는 각 쿠버네티스 노드의 `/prod` , `/sys` 에 있는 파일들을 읽어서 프로메테우스가 받아들일 수 있는 메트릭 형태로 변환하고, 이를 HTTP를 통해 `/metrics` 주소로 공개한다.

노드의 CPU 상태별로 사용된 시간을 합한 데이터나 노드별로 사용 가능한 메모리의 용량 등을 알 수 있다.

## 쿠버 스테이트 메트릭으로 쿠버네티스 클러스터 메트릭 수집하기

쿠버 스테이트 메트릭 : 쿠버네티스 상태를 보여주는 메트릭이다.

- 쿠버네티스 상태에 관한 정보를 가져와서 프로메테우스가 받아들일 수 있는 메트릭 형태로 변환하고, 이 메트릭을 HTTP 서버를 통해 `/metrics` 주소로 공개한다.
→ 노드 익스포터와의 공통점
- 각 노드의 특정 디렉토리를 마운트해서 사용하지 않고, 이미 API 서버에 모인 값들을 수집한다.
→ 노드 익스포토와의 차이점

쿠버네티스에 배포된 파드가 다시 시작하는 경우 이를 누적해 기록한 데이터나 쿠버네티스에 존재하는 서비스들이 생성된 시간 등을 알 수 있다. → API 서버를 통한 명령 데이터인듯하다.