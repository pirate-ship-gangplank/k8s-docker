# 컨테이너 인프라 환경 모니터링
* 다수의 노드로 구성된 클러스터 정보는 수집하고 분류하여 저장해야 한다.
* 거의 모든 모니터링 도구는 **수집->통합->시각화** 구조로 되어있다.

### 모니터링 도구
* 프로메테우스 (Prometheus)
  * CNCF에서 관리되고 있는 오픈 소스로, 모니터링을 위한 데이터 수집 도구이다.
  * 시계열 데이터베이스를 내장하고 있고, 자체적인 질의 페이지 외에 시각화 기능은 없기 때문에 그라파나와 연계해서 많이 사용한다.
  * 중앙 서버에서 에이전트를 통해 노드와 컨테이너 상태를 모두 수집하여 모니터링 할 수 있다.
* 데이터독 (Datadog)
  * SaaS 형태로 모니터링 기능을 제공하는 제품이다.
  * 웹사이트에서 모니터링 대상을 관리할 수 있고 여러 클라우드 서비스나 애플리케이션과 연동이 쉬워 관리 부담이 적지만 모니터링 대상마다 비용이 발생한다.
* 뉴 렐릭 (New Relic)
  * 데이터독과 같은 서비스형 소프트웨어이다.
  * 데이터독과 비교하여 성능 모니터링(APM, Application Performance Monitoring)에 더 특화되어 있다.
  * 데이터독과 마찬가지로 모니터링 대상이 많을 수록 비용 부담이 커진다.
* 인플럭스 DB (Influx DB)
  * 시계열 데이터베이스로, 오픈 소스로 공개된 라이센스와 클라우드에서 바로 사용할 수 있는 서비스형 소프트웨어이다.

### 데이터 시각화 도구
* 그라파나 (Grafana)
  * 특정 소프트웨어에 종속되지 않은 시각화 도구이며, 다양한 수집 도구 및 데이터베이스들과 연계가 가능하다.
  * 주로 시계열 데이터의 시각화에 많이 쓰이며, 관계형 데이터베이스 데이터를 표 형태로 시각화해 사용할 수도 있다.
* 키바나 (Kibana)
  * 엘라스틱서치를 개발한 엘리스틱에서 만든 시각화 도구로, 엘라스틱서치에 적재된 데이터를 시각화하거나 검색, 분석할 때도 사용한다.
  * 엘라스틱서치의 데이터만을 시각화할 수 있기 때문에 프로메테우스의 시계열 데이터를 메트릭비트(Metricbeat)라는 도구로 엘라스틱서치에 전달해야 하는 불편함이 있다.

### 프로메테우스 구성

#### prometheus-server
* 프로메테우스의 주요 기능을 수행하는 요소로, 3가지 역할을 수행한다.
  * 수집기 - 노드 익스포터 외 여러 대상에서 공개된 메트릭을 수집한다.
  * 시계열 데이터베이스 - 수집한 시계열 메트릭 데이터 저장
  * 웹 UI - 저장된 데이터를 질의하거나 수집 대상의 상태를 확인할 수 있다.

#### node-exporter
* 노드의 시스템 메트릭 정보를 HTTP로 공개하는 역할을 한다.
* 공개된 내용을 프로메테우스 서버에서 수집한다.

#### kube-state-metrics
* API 서버로 쿠버네티스 클러스터의 여러 메트릭 데이터를 수집한 후, 이를 프로메테우스 서버가 수집할 수 있는 메트릭 데이터로 변환해 공개하는 역할을 한다.

#### alertmanager
* 프로메테우스에 alert 규칙을 설정하고, alert 이벤트가 발생하면 설정된 alert 메시지를 대상에게 전달하는 기능을 제공한다.

#### pushgateway
* 배치와 스케줄 작업 시 수행되는 일회성 작업들의 상태를 저장하고 모아서 프로메테우스가 주기적으로 가져갈 수 있도록 공개한다.

### 멀티 컨테이너 패턴
* 파드 내부에 컨테이너 여러 개를 구성하는 방법
* 사이드카(Sidecar) - 메인 컨테이너의 기능을 확장하거나 기능을 향상하고자 할 때 추가하는 패턴
* 앰배서더(Ambassador) - 사용자가 외부에서 접근할 때 앰배서더 컨테이너를 통해 통신이 이루어지는 형태로, 세부적인 외부 접근 대상이나 방법은 앰배서더 컨테이너에 위임한다.
* 어댑터(Adapter) - 메인 컨테이너의 정보를 외부에서 사용할 수 있는 형식으로 변환하는 컨테이너가 추가된 형태이다. 

---
## PromQL
* 메트릭 데이터를 적절하게 추출하기 위한 표현식

### 메트릭 값의 종류
* Count
  * 누적된 값을 표현하는데 사용하는 메트릭 타입.
  * 카운터에 누적된 값으로 구간별 변화율을 파악해 해당 값의 추세를 파악할 수 있다.
  * 이벤트나 오류 등, 급증하는 구간을 파악하는데 적합하다.
* Gauge
  * 특정 시점의 값을 표현하는 데 사용하는 메트릭 타입.
  * 시점별로 증가나 감소를 모두 표현할 수 있다.
  * CPU 온도나 메모리 사용량 등 조회 하는 순간의 값이 중요할 때 게이지 타입을 사용한다.
* Histogram
  * 사전에 미리 정의한 구간 안에 있는 메트릭 값의 빈도를 측정한다.
  * 익스포터를 구현하는 단계에서 정의한 구간을 버킷(Bucket)이라고 한다.
* Summary
  * 히스토그램과 비슷하게 구간 내에 있는 메트릭 값의 빈도를 측정한다.
  * 히스토그램과 차이점은 구간이 지정되는 것이 아니라 프로메테우스 자체적으로 0~1 사이로 구간을 미리 정해놓는다.

### 메트릭 이름 규칙
* 일반적으로 total로 끝나면 누적 값이므로 카운터 타입, bytes 또는 created라는 단어로 끝나면 해당 시점의 값을 나타내므로 게이지 타입이다.

### 메트릭 레이블
* 레이블은 key-value 형태로 제공되고, 이렇게 제공되는 다수의 레이블로 원하는 레이블을 검색하고 추출할 수 있다.
* ex) up{job="prometheus"}

### 메트릭 레이블 매처
* 특정한 조건으로 레이블을 검색하는 방법을 레이블 매처라고 한다.
* =
  * 조건에 넣은 값과 레이블 값이 같은 메트릭을 보여준다.
  * {instance="m-k8s"} 은 instance 레이블 값이 m-k8s인 메트릭을 찾는다.
* !=
  * 조건에 넣은 값과 레이블 값이 다른 메트릭을 보여준다.
  * {instance!="m-k8s"} 은 instance 레이블 값이 m-k8s가 아닌 메트릭을 찾는다.
* =~
  * 조건에 넣은 정규 표현식에 해당하는 메트릭을 찾는다.
  * {instance=~"w.+"} 은 instance 레이블 값이 w로 시작하는 메트릭을 찾는다.
* !~
  * 조건에 넣은 정규 표현식에 해당하지 않는 메트릭을 찾는다.
  * {instance!~"w.+"} 은 instance 레이블 값이 w로 시작하지 않는 모든 메트릭을 찾는다.

### PromQL 연산자
* 비교 연산자
  * 레이블 매처와 유사한 형태지만 비교 대상이 숫자이므로 크기를 구분하는 조건들이 있다.
  * ==, !=, >, <, >=, <= 연산자가 존재한다.
* 논리 연산자
  * 수집된 메트릭에서 보고 싶은 범위를 지정하는 and(교집합), or(합집합), unless(차집합) 연산자가 존재한다.
* 산술 연산자
  * 사칙연산(+, -, *, /)과 나머지(%), 지수(^)와 같이 수집된 메트릭을 종합하고 분석하는 연산자이다.
* 집계 연산자
  * 평균(avg), 합계(sum), 계수(count)와 같이 수집된 메트릭을 종합하고 분석하는 연산자이다.

### PromQL 데이터 타입
* \[구간 값\] 을 통해 메트릭 값과 함께 시간 정보가 나타나 각 메트릭 값을 구분할 수 있다.
* \[5m\] 은 5분 동안 발생된 메트릭 값을 요창한다.
* 레인지 셀렉터 단위는 ms(밀리초), s(초), m(분), h(시간), d(일), w(주), y(년)을 사용할 수 있다.
* 구간이 있는 PromQL 데이터 타입을 레인지 백터(Range vector)라고 한다.
* 특정 시점에 대한 메트릭 값만 가지는 PromQL 타입을 인스턴트 벡터(Instant vector)라고 한다.
* 실수 값을 표현하는 타입을 스칼라 타입(Scalar type)이라고 한다.

### PromQL 함수
* rate
  * 수집한 값들의 변화율을 구할 때 사용한다.
  * 주로 카운터 형식의 메트릭에 사용되며, 지정된 구간이 얼마나 빠르게 변화했는지 알기 위한 지표로 사용된다.
  * ex) rate(node_cpu_seconds_total{mode="idle",kubernetes_node="w2-k8s"}\[5m\])
* irate
  * rate는 구간 시작 값과 구간 종료 값의 차이에 대한 변화율을 다루고, irate는 구간 종료 바로 전 값과 구간 종료 값의 차이에 대한 변화율을 나타낸다.
  * 구간이 매우 길면 irate의 변화율은 큰 의미가 없기 때문에 rate 함수를 사용하는 것이 낫다.
  * ex) rate(node_cpu_seconds_total{mode="idle",kubernetes_node="w2-k8s"}\[5m\])
* predict_linear
  * 레인지 벡터로 수집된 과거 메트릭 데이터를 기반으로 앞으로 생성될 메트릭 값을 예측한다.
  * ex) predict_linear(node_memory_MemAvailable_bytes{kubernetes_node="w1-k8s"}\[5m\],60\*60\*5)
  * 위 예제는 5시간 후의 사용 가능한 메모리 용량을 예측한다.

### Summary 와 Histogram
* 구간 내에 특정 메트릭 값이 나타나는 빈도를 알려준다.
* 서머리는 익스포터에서 이미 만들어진 값을 보여주고, 히스토그램은 요청을 받으면 이를 계산해서 보여준다.
