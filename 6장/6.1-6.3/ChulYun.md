# 컨테이너 인프라 환경 모니터링
* 다수의 노드로 구성된 클러스터 정보는 수집하고 분류하여 저장해야 한다.
* 거의 모든 모니터링 도구는 **수집->통합->시각화** 구조로 되어있다.

### 모니터링 도구
* 프로메테우스 (Prometheus)
  * CNCF에서 관리되고 있는 오픈 소스로, 모니터링을 위한 데이터 수집 도구이다.
  * 시계열 데이터베이스를 내장하고 있고, 자체적인 질의 페이지 외에 시각화 기능은 없기 때문에 그라파나와 연계해서 많이 사용한다.
  * 중앙 서버에서 에이전트를 통해 노드와 컨테이너 상태를 모두 수집하여 모니터링 할 수 있다.
* 데이터독 (Datadog)
  * SaaS 형태로 모니터링 기능을 제공하는 제품이다.
  * 웹사이트에서 모니터링 대상을 관리할 수 있고 여러 클라우드 서비스나 애플리케이션과 연동이 쉬워 관리 부담이 적지만 모니터링 대상마다 비용이 발생한다.
* 뉴 렐릭 (New Relic)
  * 데이터독과 같은 서비스형 소프트웨어이다.
  * 데이터독과 비교하여 성능 모니터링(APM, Application Performance Monitoring)에 더 특화되어 있다.
  * 데이터독과 마찬가지로 모니터링 대상이 많을 수록 비용 부담이 커진다.
* 인플럭스 DB (Influx DB)
  * 시계열 데이터베이스로, 오픈 소스로 공개된 라이센스와 클라우드에서 바로 사용할 수 있는 서비스형 소프트웨어이다.

### 데이터 시각화 도구
* 그라파나 (Grafana)
  * 특정 소프트웨어에 종속되지 않은 시각화 도구이며, 다양한 수집 도구 및 데이터베이스들과 연계가 가능하다.
  * 주로 시계열 데이터의 시각화에 많이 쓰이며, 관계형 데이터베이스 데이터를 표 형태로 시각화해 사용할 수도 있다.
* 키바나 (Kibana)
  * 엘라스틱서치를 개발한 엘리스틱에서 만든 시각화 도구로, 엘라스틱서치에 적재된 데이터를 시각화하거나 검색, 분석할 때도 사용한다.
  * 엘라스틱서치의 데이터만을 시각화할 수 있기 때문에 프로메테우스의 시계열 데이터를 메트릭비트(Metricbeat)라는 도구로 엘라스틱서치에 전달해야 하는 불편함이 있다.

### 프로메테우스 구성

#### prometheus-server
* 프로메테우스의 주요 기능을 수행하는 요소로, 3가지 역할을 수행한다.
  * 수집기 - 노드 익스포터 외 여러 대상에서 공개된 메트릭을 수집한다.
  * 시계열 데이터베이스 - 수집한 시계열 메트릭 데이터 저장
  * 웹 UI - 저장된 데이터를 질의하거나 수집 대상의 상태를 확인할 수 있다.

#### node-exporter
* 노드의 시스템 메트릭 정보를 HTTP로 공개하는 역할을 한다.
* 공개된 내용을 프로메테우스 서버에서 수집한다.

#### kube-state-metrics
* API 서버로 쿠버네티스 클러스터의 여러 메트릭 데이터를 수집한 후, 이를 프로메테우스 서버가 수집할 수 있는 메트릭 데이터로 변환해 공개하는 역할을 한다.

#### alertmanager
* 프로메테우스에 alert 규칙을 설정하고, alert 이벤트가 발생하면 설정된 alert 메시지를 대상에게 전달하는 기능을 제공한다.

#### pushgateway
* 배치와 스케줄 작업 시 수행되는 일회성 작업들의 상태를 저장하고 모아서 프로메테우스가 주기적으로 가져갈 수 있도록 공개한다.

### 멀티 컨테이너 패턴
* 파드 내부에 컨테이너 여러 개를 구성하는 방법
* 사이드카(Sidecar) - 메인 컨테이너의 기능을 확장하거나 기능을 향상하고자 할 때 추가하는 패턴
* 앰배서더(Ambassador) - 사용자가 외부에서 접근할 때 앰배서더 컨테이너를 통해 통신이 이루어지는 형태로, 세부적인 외부 접근 대상이나 방법은 앰배서더 컨테이너에 위임한다.
* 어댑터(Adapter) - 메인 컨테이너의 정보를 외부에서 사용할 수 있는 형식으로 변환하는 컨테이너가 추가된 형태이다. 
