## 5장 : 지속적 통합과 배포 자동화, 젠킨스

## 5.4 : 젠킨스로 CI/CD 구현하기

- 아이템

젠킨스에서 아이템이란 새롭게 정의할 작업을 의미합니다

- 프로젝트

모든 작업의 정의와 순서를 모아 둔 전체 작업

Freestyle project : 사용자가 직접 설정값과 수행할 동작을 입력할 수 있지만, 입력한 항목의 명세서를 별도로 저장하는 과정이 없으므로 작성한 내용을 공유하기 어렵습니다

Pipeline : 고유의 Pipeline 문법으로 코드를 작성해 작업을 정의하는 프로젝트. 진입 장벽이 높습니다.

Multi-configuration project : 하나의 소스 코드를 여러 조건의 조합으로 나온 경우의 수에 해당하는 환경에 동시에 배포하는 프로젝트

Multibranch Pipeline : 하나의 소스 코드 저장소 내에 존재하는 각 브랜치에서 파이프라인 코드가 작성된 파일을 불러와 한 번에 여러 브랜치에 대해 품질 검증, 테스트, 빌드 등의 작업을 할 수 있도록 도와줍니다

### 5.4.1 : Freestyle로 간단히 echo-ip 배포하기

####젠킨스 Freestyle로 CI/CD를 구성하는 순서

1. 깃허브에서 echo-ip를 빌드할 정보가 담긴 파일들을 내려받기
   
2. 받은 파일들을 이용해서 컨테이너 이미지를 빌드하기
   
3. 빌드한 이미지를 레지스트리에 저장하기

4. 레지스트리에 저장한 이미지를 쿠버네티스 클러스터에 디플로이먼트로 생성하고 로드밸런서 서비스로 노출하기

### 5.4.2 : Pipleline 프로젝트로 손쉽게 echo-ip 배포하기

Freestyle 경우에는 화면에서 메뉴를 눌러서 정의하는 방식이기 때문에 여러 사람들에게 전달하려면 사용법을 책자로 만들고 교육해야 합니다

또한, 일부 내용이 변경되면 다시 책자를 만들거나 변경된 내용을 교육해야 합니다

이를 위해 젠킨스는 Pipeline 을 통해서 CI/CD 내용을 코드 또는 파일로 정의해 단순히 해당 코드 또는 파일을 가져다 쓰면 모든 것이 쉽게 되도록 지원합니다

젠킨스 Pipeline 은 크게 2가지의 문법으로 코드를 작성할 수 있습니다.

1. 스크립트 문법 (익숙하지 않은 젠킨스의 고유 문법)

2. 선언적인 문법 (야믈 파일)

####젠킨스 Pipeline으로 CI/CD를 구성하는 순서

1. 깃허브와 같은 소스 코드 저장소에서 빌드할 소스 코드와 젠킨스 내부의 작업을 선언적인 문법으로 정의해 둔 Jenkinsfile을 내려받습니다

2. 내려받은 Jenkinsfile을 해석해서 작성자의 의도에 맞는 작업을 자동으로 수행합니다.

이때, Jenkinsfile을 통해 이루어지는 것은 5.4.1 Freestyle로 진행한 내용과 같습니다.

- Jenkinsfile 구성 요소
  - pipeline : 선언적인 문법이 시작하는 부분
  - agent : 작업을 수행할 에이전트를 지정하고 필요한 설정
    - any : 사용 가능한 에이전트를 젠킨스가 임의로 지정
    - label : 특정 레이블과 일치하는 에이전트 노드를 지정
    - docker : 에이전트 노드의 이미지를 도커로 지정
    - kubernetes : 에이전트 노드를 쿠버네티스 파드로 지정
  - stages : stage들을 모아서 정의하고 이를 순서대로 진행
  - stage : step 들을 정의하는 영역
  - steps : stage 내부에서 실제 작업 내용을 작성하는 영역

### 5.4.3 : Pipleline 프로젝트로 구현하는 블루그린 배포 전략

파드의 특성상 배포되는 애플리케이션의 변경이 있다면 언제나 삭제하고 다시 생성하는 과정을 거칩니다

하지만, 중요한 서비스가 동작하고 있는 경우 이렇게 중단되는 시간이 발생하는 것은 큰 부담일 수 있습니다

- 롤링 업데이트

파드를 레플리카셋 단위로 나누어 모든 레플리카셋에 속해 있는 파드가 업데이트 된 이후에 레플리카셋을 삭제합니다

롤링 업데이트 배포 과정에서 내부의 파드 개수가 많으면 업데이트 과정이 길어져 다른 두 가지의 버전이 오랫동안 공존하는 경우가 있습니다

이를 방지하기 위한 좋은 방법은 **블루 그린** 배포 전략을 사용하는 것입니다

- 블루 그린

'모든 파드가 업데이트된 이후에 트래픽을 전달하자'

2개의 디플로이먼트를 생성하고 기존에 배포된 디플로이먼트(블루)로 계속 트래픽을 전달하다가

새로 배포되는 디플로이먼트(그린)에 모든 파드가 업데이트돼 트래픽을 처리하는 데 문제가 없을 때 서비스를 모두 새로 배포된 디플로이먼트(그린)으로 넘깁니다

그리고 기존 디플로이먼트(블루)를 삭제합니다

이와 같이 서비스를 제공하게 된다면 중단 없이 연속적으로 배포가 가능합니다

만약, 배포된 서비스의 장애가 생겼다면 기존에 서비스하던 디플로이먼트로 원복하는 것도 수월해 장애 복구도 쉽습니다

하지만, 배포를 위한 디플로이먼트를 만들어야 하기 때문에 기존 대비 최소 2배 이상의 리소스를 더 필요로 한다는 제약 사항이 있습니다

## 5.5 : 젠킨스 플로그인을 통해 구현되는 GitOps

쿠버네티스 플러그인은 CI/CD를 실제로 수행하는 젠킨스 에이전트 파드를 사용자가 신경쓰지 않아도 자동으로 배포 관리하게 해줍니다

현업에서는 젠킨스의 단일 플러그인으로 CI/CD를 구성하는 것이 아니라 여러 플러그인을 조합해 현재 업무에 맞는 형태로 만들어서 사용합니다

####젠킨스가 제공하는 플러그인 종류

- Platforms : 웹 애플리케이션이 아닌 다른 플랫폼에서 작동하는 애플리케이션 빌드를 위한 플러그인

- User interface : 젠킨스의 기본 UI 이외의 확장 UI를 적용하기 위한 플러그인 카테고리

- Administration : LDAP, 젠킨스 클러스터 관리 등 젠킨스 자체 관리에 필요한 플러그인 종류

- Source code management : 깃허브 및 깃랩과 같은 소스 코드 저장소의 연결이나 관리를 위한 플러그인 카테고리입니다

- Build management : CI/CD 단게에서 추가적으로 사용할 수 있는 플로그인 종류입니다

플러그인을 조합해서 GitOps 를 구현할 수 있습니다

#### GitOps 의 이점

- 깃허브 저장소의 내용과 실제 사용 및 운영 환경의 내용을 동일하게 가져갈 수 있습니다

이를 통해 깃허브 저장소로 모든 내용을 단일화해 관리하고 히스토리도 관리할 수 있으며 문제가 생기면 빠르게 복원할 수 있습니다

- 배포를 표준화해 자동으로 배포되도록 할 수 있습니다
  
배포 과정을 미리 정의해 깃허브 저장소에 변경된 내용을 선언만 하면 모든 배포가 자동으로 진행됩니다

- 사람의 실수를 줄일 수 있습니다

모든 배포 과정은 자동화되므로 사람마다 다르게 행동해 발생하는 실수를 방지하고 더욱 견고한 시스템을 만들 수 있습니다

### 5.5.1 : 쿠버네티스 환경에 적합한 선언적인 배포 환경

쿠버설정 파일이 담고 있는 내용

- clusters : 어떤 쿠버네티스 클러스터에 접속할지에 대한 정보가 담겨 있는 부분

clusters는 접속 대상이 되는 클러스터의 정보를 여러 개 포함할 수 있습니다

각 클러스터 접속 정보는 API 서버의 주소와 인증 기관 정보로 이루어져 있습니다

- contexts : 위에서 설명한 클러스터의 정보와 곧이어 설명할 사용자 정보의 조합이 담겨 있는 부분입니다

kubectl 명령어를 통해 클러스터에 접속할 때는 현재 context에 설정된 user의 자격을 가지고 설정된 cluster에 접속하게 됩니다

- current-context : 현재 사용 중인 context 가 무엇인지 나타내는 부분입니다

- users : 클러스터에 접속하는 사용자가 누구인지 사용자 정보가 담겨 있는 부분입니다

쿠버설정 파일은 쿠버네티스 클러스터에 접근할 수 있는 매우 민감한 정보를 포함하고 있기 때문에 취급에 유의해야 합니다

### 5.5.2 : 슬랙을 통해 변경 사항 알리기

선언적인 배포 시스템을 구축해 기초적인 GitOps 환경을 만들었지만

보다 안정적인 GitOps 환경을 위해서는 구축한 시스템에 대한 알림 메시지 등을 받아서 즉각적인 조치를 취할 필요가 있습니다

#### 젠킨스 <-> 슬랙을 연동하는 단계

1. 젠킨스가 슬랙으로 메시지를 보낼 수 있는 대상인 슬랙 채널을 생성합니다

2. 슬랙 채널에 젠킨스가 보내는 메시지를 전달할 수 있는 Jenkins CI 앱을 추가해 젠킨스에서 슬랙 채널 연동을 위한 토큰과 워크스페이스 도메인 주소 값을 확인합니다

3. 슬랙에서 발급한 토큰은 공개되면 매우 민감한 정보이므로 젠킨스 자격 증명에 토큰을 등록합니다

4. 젠킨스에서 슬랙으로 메시지를 보내기 위해서 슬랙 알림 플러그인을 설치하고 시스템 설정 메뉴에 토큰과 워크스페이스 도메인 주소를 입력해 연동 작업을 마칩니다