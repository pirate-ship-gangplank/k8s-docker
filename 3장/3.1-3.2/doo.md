# 쿠버네티스 이해하기

**쿠버네티스** : 컨테이너 오케스트레이션을 위한 솔루션

**오케스트레이션** : 

- 복잡한 단계를 관리하고 요소들의 유기적인 관계를 미리 정의해 손쉽게 사용하도록 서비스를 제공하는 것
- 다수의 컨테이너를 유기적으로 연결, 실행, 종료할 뿐만 아니라 상태를 추적하고 보존하는 등의 컨테이너를 안정적으로 사용할 수 있게 만들어주는 것

# 쿠버네티스 구성 요소

## 마스터 노드

### **kubectl**

쿠버네티스 클러스터에 명령을 내리는 역할

### **API 서버**

쿠버네티스 클러스터의 중심 역할을 하는 통로

- 주로 상태 값을 저장하는 etcd와 통신하지만, 그 밖의 요소들 또한 API 서버를 중심으로 두고 통신하므로 매우 중요하다.
- 회사로 치면 모든 직원과 상황을 관리하고 목표를 설정하는 관리자의 역할이다.

### etcd

구성 요소들의 상태 값이 모두 저장되는 곳

- etcd에 모든 상태값이 있기 때문에 etcd만 백업되어 있으면 장애 상황에서도 쿠버네티스 클러스터를 복구할 수 있다.
- **분산 저장**이 가능한 key-value 저장소로, 복제해서 여러 곳에 저장해두면 하나의 etcd에 장애가 나더라도 **시스템의 가용성을 확보**할 수 있다.
- 회사로 치면 관리자가 모든 보고 내용을 기록하는 노트이다.

### 컨트롤러 매니저

쿠버네티스 클러스터의 오브젝트 상태를 관리

- 워커 노드에서 통신이 되지 않는 경우, 상태 체크와 복구는 컨트롤러 매니저에 속한 노드 컨트롤러에서 한다.
- 서비스와 파드를 연결하는 역할을 하는 엔드포인트 컨트롤러의 역할을 한다.

### 스케줄러

노드의 상태와 자원, 레이블, 요구 조건 등을 고려해 파드를 어떤 워커 노드에 생성할 것인지를 결정하고 할당

- 파드 조건에 맞는 워커 노드에 지정하고, 파드가 워커 노드에 할당되는 일정을 관리하는 역할을 담당한다.

## 워커 노드

### kubelet

파드의 구성 내용을 받아서 컨테이너 런타임으로 전달하고, 파드 안의 컨테이너들이 정상적으로 작동하는지 모니터링한다.

### 컨테이너 런타임

파드를 이루는 컨테이너의 실행을 담당

- 파드 안에서 다양한 종류의 컨테이너가 문제 없이 작동하게 만드는 표준 인터페이스이다.

### 파드

1개 이상의 컨테이너로, 단일 목적의 일을 하기 위해서 모인 단위

- 웹 서버 역할을 할 수도 있고, 로그나 데이터를 분석할 수도 있다.
- 언제라도 죽을 수 있는 존재이다.

## 선택 가능한 구성 요소

### 네트워크 플러그인

쿠버네티스 클러스터의 통신을 위해서 네트워크 플러그인을 선택하고 구성해야 한다. 

- 네트워크 플러그인은 일반적으로 CNI로 구성한다.

CNI : Container Network Interface. 컨테이너의 네트워크 안정성과 확작성을 보장하기 위해 개발된 것.

### CoreDNS

빠르고 유연한 DNS 서버

- 쿠버네티스 클러스터에서 도메인 이름을 이용해 통신하는데 사용한다.
- 실무에서 쿠버네티스 클러스터를 구성하여 사용할 때는 IP보다 도메인 네임을 편리하게 관리해주는 CoreDNS를 사용하는 것이 일반적이다.

# 파드의 생명 주기

파드가 생성, 수정, 삭제되는 과정

1. kubectl을 통해 API 서버에 파드 생성을 요청
2. (업데이트가 있을 때마다 매번) API 서버에 전달된 내용이 있으면 API 서버는 etcd에 전달된 내용을 모두 기록해 클러스터의 상태 값을 최신으로 유지한다. 따라서 각 요소가 상태를 업데이트할 때마다 모두 API 서버를 통해 etcd에 기록한다.
3. API 서버에 파드 생성이 요청된 것을 컨트롤러 매니저가 인지하면 컨트롤러 매니저는 파드를 생성하고, 이 상태를 API 서버에 전달한다. (아직 어떤 워커 노드에 파드를 적용할지는 결정되지 않은 상태로 파드만 생성)
4. API 서버에 파드가 생성됐다는 정보를 스케줄러가 인지한다. 스케줄러는 생성된 파드를 어떤 워커 노드에 적용할지 조건을 고려해 결정하고, 해당 워커 노드에 파드를 띄우도록 요청한다.
5. API 서버에 전달된 정보대로 지정한 워커 노드에 파드가 속해 있는지 스케줄러가 kubelet으로 확인한다.
6. kubelet에서 컨테이너 런타임으로 파드 생성을 요청한다.
7. 파드가 생성된다.
8. 파드가 사용 가능한 상태가 된다.

쿠버네티스는 작업을 순서대로 진행하는 워크플로 구조가 아니라 선언적인 시스템 구조를 가지고 있다.
→ 각 요소가 추구하는 상태를 선언하면 현재 상태와 맞는지 점검하고 그것에 맞추려고 노력하는 구조이다.

---

# 쿠버네티스 기본 사용법

# 오브젝트

쿠버네티스를 사용하는 관점에서 파드와 디플로이먼트는 스펙과 상태 등의 값을 가지고 있는데, 이러한 값을 가지고 있는 파드와 디폴로이먼트를 개별 속성을 포함해 부르는 단위를 오브젝트라고 한다.

## 기본 오브젝트

### 파드

쿠버네티스에서 실행되는 최소 단위, 즉 웹 서비스를 구동하는데 필요한 최소 단위

- 독립적인 공간과 사용 가능한 IP를 가지고 있다.
- 하나의 파드는 1개 이상의 컨테이너를 가지고 있기 때문에 여러 기능을 묶어 하나의 목적으로 사용할 수도 있다. (그러나 범용으로 사용할 때는 대부분 1개의 파드에 1개의 컨테이너를 적용한다.)

### 네임스페이스

쿠버네티스 클러스터에서 사용되는 리소스들을 구분해 관리하는 그룹. (3장에서 아래의 3가지 네임스페이스 사용)

- 특별히 지정하지 않으면 default
- 쿠버네티스 시스템에서 사용되는 kube-system
- 온프레미스에서 쿠버네티스를 사용할 경우 외부에서 쿠버네티스 클러스터 내부로 접속하게 도와주는 컨테이너들이 속해있는 metallb-system

### 볼륨

파드가 사라지더라도 저장과 보존이 가능한 디렉터리를 볼륨 오브젝트를 통해 제공

- 파드가 생성될 때 파드에서 사용할 수 있는 디렉터리를 제공하는데, 기본적으로 파드는 영속되는 개념이 아니라 제공되는 디렉터리도 임시로 사용한다.

### 서비스

새로 파드가 생성될 때 부여되는 새로운 IP를 기존에 제공하던 기능과 연결해주는 역할 

- 쿠버네티스 외부에서 내부로 접속할 때 내부의 구조나 파드가 살았는지 등을 신경쓰지 않아도 이를 논리적으로 연결해준다.
- 기존 인프라에서 로드밸런서, 게이트웨이의 역할을 한다.

## 디플로이먼트

기본 오브젝트만으로도 쿠버네티스를 사용할 수 있지만, 한계가 있어 이를 좀더 효율적으로 작동하도록 기능들을 조합하고 추가해 구현한 것

- 쿠버네티스에서 가장 많이 쓰이는 디플로이먼트 오브젝트는 파드에 기반을 두고 있으며, 레플리카셋 오브젝트를 합쳐 놓은 형태이다.
- 다수의 파드가 필요할 때 하나씩 생성하면 매우 비효율적이다. 이때 다수의 파드를 만드는 레플리카셋 오브젝트를 사용한다.
- 레플리카셋은 파드 수를 보장하는 기능만 제공하기 때문에 롤링 업데이트 기능 등이 추가된 디플로이먼트를 사용해 파드 수를 관리하면 좋다.

## 스펙을 지정해 오브젝트 생성

오브젝트 스펙를 통해 디플로이먼트에 대한 설정 정보를 yaml 파일로 작성할 수 있다.

### 오브젝트 생성 명령어

run을 사용하면 간단하지만 단일 파드만을 생성할 수 있고, create를 사용하면 파일의 변경 사항을 바로 적용할 수 없다. 이런 경우에 apply를 사용해서 오브젝트를 생성할 수 있다.


### 파드의 컨테이너 자동 복구

쿠버네티스는 거의 모든 부분이 자동 복구되도록 설계됐다. 특히 파드의 자동 복구 기술을 셀프 힐링이라고 하는데, 제대로 작동하지않는 컨테이너를 다시 시작하거나 교체해 파드가 정상적으로 작동하게 한다.

- 디플로이먼트에 속한 파드는 삭제를 해도 자동으로 새로운 파드를 생성하면서 복구를 한다.
→ 이러한 경우에 상위 디플로이먼트를 삭제해야 하위 파드가 삭제된다.

### 노드 유지보수하기

노드 유지보수를 위해 drain 명령을 통해 지정된 노드의 파드를 전부 다른 곳으로 이동시켜 해당 노드를 유지보수할 수 있다.

### 파드 업데이트하고 복구하기

- 파드 업데이터
- 업데이트 실패시 파드 복구
- 특정 시점으로 파드 복구