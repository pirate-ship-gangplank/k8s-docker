쿠버 네티스 이해하기
---
## 컨테이너 인프라 환경
컨테이너 인프라 환경

: 리눅스 운영 체제의 커널 하나에서 여러개의 컨테이너가 격리된 상태로 실행되는 인프라 환경

컨테이너

: 하나 이상의 목적을 위해 독립적으로 작동하는 프로세스 

각각의 가상 머신이 독립적인 운영체제 커널을 가져야하는 가상화 환경과 달리 운영체제 커널 하나에 여러 개가 격리된 형태로 실행되기 때문에 자원을 효율적으로 사용 가능

## 컨테이너 오케스트레이션
컨테이너 오케스트레이션

: 복잡한 단계를 관리하고 요소들의 유기적인 관례를 미리 정의해 손쉽게 사용하도록 서비스를 제공하는 것

이를 지원하는 여러가지 솔루션

- 도커 스윔
- 메소스
- 노매드
- 쿠버네티스

## 쿠버네티스 구성 방법

크게 3가지로 구분

- 관리형 쿠버네티스
- 설치형 쿠버네티스
- 구성형 쿠버네티스

## 쿠버네티스 구성 요소

###마스터 노드
1. kubectl

> 클러스터에 명령을 내리는 역할,
바이너리 형태로 배보가 되어 있어 마스터 노드에 있을 필요x,
통상적으로 api서버와 주로 통신하기에 마스터노드에 위치있다고 가정하고 설명

2. api 서버

> 클러스터의 중심 역할을 하는 통로,
> 주로 상태값을 저장하는 etcd와 통신하지만 대부분의 요소들이 api서버를 중심으로 통신하기에 중요


3. etcd

> etc dir + distributed = etcd
> 
> 구성요소의 상태 값이 모두 저장되는 곳,
> etcd외 다른 구성요소는 상태값을 관리x
> 따라서 etcd만 잘 백업해둔다면 긴급한 장애 상황에서도 쿠버네티스 클러스터는 복구할 수 있다.

4. 컨트롤러 매니저

> 클러스터의 오브젝트 상태 관리 
> 
>  ex) 
> 1.워커 노드에서 통신이 되지 않는 경우, 상태 체크와 복구<br>
> 2.서비스와 파드를 연결하는 역할을 하는 엔드 포인트 컨트롤러 또한 컨트롤러 매니저

5. 스케줄러

> 노드 상태와 자원, 레이블 요구 조건 등을 고려하여 파드를 어떤 워커 노드에 생성할 것인지 결정하고 할당.
> 파드를 조건에 맞는 워커노드에 지정 및 워커 노드에 할당되는 일정을 관리

###워커 노드

6. kubelet

> 파드의 구성 내용을 받아서 컨테이너 런타임으로 전달, 파드 안 컨테이저의 정상 작동을 모니터링

7. 컨테이너 런타임

> 파드를 이루는 컨테이너의 실행을 담당,
> 파드 안에서 다양한 종류의 컨테이너가 문제업이 작동하게 만드는 표준 인터페이스

8. 파드(Pod)

> 한 개 이상의 컨테이너로 단일 목적의 일을 하기 위해서 모인 단위, <strong>언제라도 죽을 수 있음</strong>


의문점: 책에서 컨테이너의 설명을 하나이상의 목적을 위해서 독립적으로 작동하는 프로세스라고 했는데 파드는 그러한 컨테이너라고 하고는 단일 목적을 위해서 모인 단위라고 한다. 파드도 다중목적을 위해서 사용할 수 있는 것 아닌가?


### 선택 가능한 노드
9. 네트워크 플러그인

> CNI(Container Network Interface)로 구성하는 것이 일반적, 책에서는 캘리코를 선택

10. CoreDNS

> 클라우드 네이티브 컴퓨팅 재단에서 보증하는 프로젝트, 빠르고 유연함. IP보다 도메인 네임을 편리하게 관리해주는 CoreDNS를 사용하는 것이 일반적

## 사용자가 배포된 파드에 접속할 때

1) kube-proxy를 통해 파드가 통신할 수 있는 network를 설정
2) 파드에 접속 -> 필요한 내용을 전달

## 생명주기로 쿠버네티스 구성요소 보기

1. kubectl을 통해 api서버에 파드 생성 요청
2. api서버에 전달된 내용이 있으면 etcd에 전달된 내용을 모두 기록 + 클러스터의 상태값을 최신으로 유지
3. api서버에 파드생성 요청을 컨트롤러 매니저가 인지하면 파드생성 + api서버에 이 상태를 전달(아직 파드가 어떤 워커 노드에서 사용될지는 결정x)
4. 파드 생서을 스케줄러가 인지 + 어떤 워커 노드에 할당할지 결정 및 요청
5. api 서버에 전달된 정보 대로 지정한 워커 노드에 파드가 속해 있는지 스케줄러가 kubelet으로 확인
6. kublet에서 컨테이너 런타임으로 파드 생성을 요청
7. 파드 생성?(그림에서는 컨테이너, 글에서는 파드)
8. 파드가 사용 가능한 상태가 됨

쿠버네티스는 <strong>선언적인 구조</strong>를 가진다.

따라서 추구하는 상태와 현재상태를 항상 점검하고 그것에 맞추려고 하는 구조이다.

api서버에서 항상 현재 상태와 요청 상태를 비교 그에 맞는 상태 변경 필수 

이를 위해 api서버와 etcd는 항상 한몸처럼 행동

여기서 반전으로 워커 노드는 워커플로 구조로 선언적인 구조가 아니다



쿠버 네티스 기본 사용법 이해
---

## 파드 생성
kubectl run, kubectl create 이 둘의 차이는 무엇일까?

Deployment에 pod를 생성하냐 아니면 단독으로 생성하냐의 차이다.

run을 사용하면 단일 파드 한 개만 생성되고 관리되지만, create를 사용하면 deployment라는 관리 그룹 내에서 파드가 생성된다.

## 오브젝트란?
파드, deployment + 개별속성 = object

### 기본 오브젝트
- 파드

> 쿠버네티스에서 실행되는 최소 단위, 독립적이 공간과 사용가능한 ip를 가지고 있다. 하나의 파드는 하나 이상의 컨테이너를 가지기에 여러기능을 묶어 하나의 목적으로 사용할 수도 있다
> but 범요으로 사용할 경우 1파드 = 1컨테이너를 적용한다.

- 네임스페이스

> 클러스터에서 사용되는 리소스들을 구분해 관리하는 그룹

- 볼륨

> 파드가 생성될 때 파드에서 사용할 수 있는 디렉토리를 제공.
> 파드에 영속되는 개념x, 제공되는 디렉토리도 임시로 사용.

- 서비스

> 파드는 클러스터 내에서 유동적->접속 정보가 고정적일 수 없다.
> 파드 접속을 안정적으로 유지하도록 서비스를 통해서 외/내부를 연결.
> 서비스는 새로 파드가 생성될 때 부여되는 새로운 ip를 기존에 제공하던 기능과 연결해준다.
> 책에서 3.3에서 자세히 설명한다고 한다.

## 디플로이먼트

기본 오브젝트 만으로 쿠버네비스 사용가능 but 한계가 분명히 존재

=>  이를 효율적으러 작동하도록 기능들을 조합하고 추가해 구현 == deployment

쿠버네티스에서 가장 많이 쓰이는 deployment object는 파드에 게반을 두고 있으면 레플리카셋 오브젝트를 합쳐 놓은 형태이다.

api서버와 컨트롤러 매니저는 단순 파드 생성을 감시하는 것x, 디플로이먼트처럼 레플리카세을 포함하는 오브젝트의 생성을 감시


## 스펙을 지정해 오브젝트 생성

디플로이먼트를 생성하면서 다수의 파드를 생성하기 위해서는 오브젝트 스펙이라는 것을 작성해야한다.(YAML 문법 사용)

## 파드의 컨테이너 자동복구 방법

쿠버네티스는 거의 모든 부분이 자동 복구되도록 설계, 특히 파드의 자동 복구 기술을 셀프 힐링이라고 지칭

작동하지 않는 컨테이너를 다시 시작하거나 교체해 정상적으로 작동하게 한다.

이외에도 레플리카셋으로 만든 디플로이먼트에서 특정 파드를 삭제하면 레플리카셋에 설정된 파드의 개수만큼 다시 파드를 생성하는 것을 볼 수 있다.

## 노드 자원 보호하기

문제가 생길 가능성이 있는 노드라는 것을 어떻게 쿠버네티스는 알려줄까?

cordon 기능을 사용

## 노드 유지보수하기

쿠버네티스를 사용하다보면 정기 또는 비정기적인 유지보수를 위해 노드를 꺼야하는 상황이 발생

이럴 때 drain 기능을 제공

drain : 지정된 노드의 파드를 전부 다른 곳으로 이동 시켜 해당 노드를 유지보수할 수 있게 한다.

## 파드 업데이트 및 복구
### 업데이트
--record 옵션을 사용하여 파드를 배포

### 복구
업데이트 실패시 파드를 복귀 해야한다.
이때 github처럼 rollout status를 실행하고 문제를 확인 describe로 더 자세히 확인 후 rollout history, undo 를 사용하여 이전 단계로 복구를 진행
















