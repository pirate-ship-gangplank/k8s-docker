## 노드 포트

외부에서 쿠버네티스 클러스터에 접속하는 가장 쉬운 방법

서비스 : 쿠버네티스에서의 서비스는 외부에서 쿠버네티스 클러스터에 접속하는 방법을 의미한다

- 모든 워커 노드의 특정 포트(노드 포트)를 연다.
- 노드포드 들어오는 모든 요청을 NodePort 서비스로 전달한다.
- NodePort 서비스는 해당 업무를 처리할 수 있는 파드로 요청을 전달한다.

```yaml
apiVersion: v1
kind: Service
...
spec:
	ports:
		- name: http
		  protocol: TCP
		  port: 80 # 서비스가 파드로 보내줄 연결 포트
		  targetPort: 80
		  nodePort: 30000 # 30000 port 오픈
```

→ 워커 노드의 IP + 오픈된 노드 포트로 접속했을때 파드 접속 성공

## 부하 분산 (로드밸런싱)

만약 파드가 여러개가 됐을 경우에 부하 분산(로드밸런싱)을 할 수 있다.

- 파드가 1개일 때 계속 워커 노드에 접속하면 1개의 파드 네임만 출력된다.
- `kubectl scale deployment np-pods --replicas=3` → 파드를 3개로 증가
- 다른 파드의 이름도 함께 출력된다. (늘어난 파드 네임)

→ nodeport.yaml 파일에 `np-pods`로 묶인 부분 때문에 추가된 파드를 외부에서 추적이 가능하다.

### expose 명령어로 노드포트 서비스 생성하기

`kubectl expose deployment np-pods --type=NodePort --name=np-svc-v2 --port=80`

→ 32163 무작위 포트 번호를 부여 받았음. 해당 포트로 접속시 배포된 파드 네임이 정상 출력된다.

→ 무작위로 생성되는 포트 번호는 30000~32767에서 임의로 지정된다.

## 인그레스 Ingress

고유한 주소를 제공해 사용목적에 따라 다른 응답을 제공할 수 있고, 트래픽에 대한 L4/L7 로드밸런서와 보안 인증서를 처리하는 기능을 제공한다.

- 노드마다 설정된 노드포트를 통해 노드포트 서비스로 접속한다. 이때 노드포트 서비스를 NGINX 인그레스 컨트롤러로 구성한다.
- NGINX 인그레스 컨트롤러는 사용자의 접속 경로에 따라 적합한 클러스터 IP 서비스로 경로를 제공한다.
- 클러스터 IP 서비스는 사용자를 해당 파드로 연결해준다.

`ingress-config.yaml` → 들어오는 주소 값과 포트에 따라 노출된 서비스를 연결하는 역할을 설정

```yaml
...
rules:
- http:
	paths:
	- path:  # 노드포트/ 경로인 경우 hname-svc-default 서비스와 연결된 파드와 연결
		backend:
			serviceName: hname-svc-default
			servicePort: 80
	- path: /ip  # 노드포트/ip 경로로 들어오면 ip-svc 서비스와 연결된 파드와 연결
		backend:
			serviceName: ip-svc
			servicePort: 80
...
```

`ingress.yaml` → 외부에서 NGINX 인그레스 컨트롤러에 접속할 수 있도록 노드포트 서비스로 NGINX 인그레스 컨트롤러를 외부에 노출하는 설정

```yaml
...
spec:
	ports:
		- name: http  # http를 처리하기 위해 30100 포트로 들어온 것을 80번 포트로 넘긴다.
			protocol: TCP
			port: 80
			targetPort: 80
			nodePort: 30100
		- name: https  # https를 처리하기 위해 30101 포트로 들어온 것을 443번 포트로 넘긴다.
			protocol: TCP
			port: 443
			targetPort: 443
			nodePort: 30101
...
```

30101 포트로 접속했을 때, 400 Bad Request 발생..

The Plain HTTP request was sent to HTTPS port 메세지 전달

### 클라우드 로드밸런서

지금까지의 방식

`워커 노드의 노드 포트가 요청을 받음 → 노드포트 서비스로 요청 전달 → 노드포트 서비스가 적합한 노드에 요청 전달` 

→ 이와 같이 비효율적인 방법으로 요청을 처리했다.

하지만, 클라우드가 제공하는 로드밸런서를 사용하면 

`클라우드 로드밸런서가 사용자의 요청을 받음 → 바로 파드에게 요청을 전달` 과 같이 간단하게 전달이 가능해진다.

### 온프레미스에서의 로드밸런서 MetalLB

온프레미스에서 MetalLB라는 베어메탈로 구성된 로드밸런스를 구성하여 사용할 수도 있다.

## 부하에 따라 파드 수를 조절하는 HPA

사용자가 갑자기 늘어나 감당할 수 있는 파드 수가 부족해지면 서비스가 중단될 수 있다. 이럴 때 HPA를 이용하여 부하량에 따라 디플로이먼트의 파드 수를 유동적으로 관리한다.

- Metrics-Server를 통해 계측값을 전달받아 HPA가 자원을 요청한다. 따라서 메트릭 서버도 구성해야한다.

## 알아두면 좋은 쿠버네티스 오브젝트

### 데몬셋

디플로이먼트의 replicas가 노드 수만큼 정해져 있는 형태. 노드 하나당 파드 한개만을 생성한다.

### 컨피그맵

설정을 목적으로 사용하는 오브젝트

### PV와 PVC

PV(Persistent Volume)는 볼륨을 사용할 수 있게 준비하는 단계, PVC(Persistent Volume Claim)는 준비된 볼륨에서 일정 공간을 할당받는 것이다.

- 쿠버네티스는 필요할 때 PVC를 요청해 사용하고, PVC를 사용하려면 PV로 볼륨을 선언해야한다.
→ PV는 관리자가 필요한 볼륨을 준비하고, PVC는 그 볼륨을 사용자가 원하는 만큼 나누어 전달한다.

### 스테이트풀셋

파드를 replicas로 생성했을때 replicas에 선언된 만큼 무작위로 생성되어서, 이름과 순서를 예측하기 어려웠다.

- 스테이트풀셋을 사용하면 각 파드가 순서대로 생성되기 때문에 고정된 이름, 볼륨, 설정 등을 가질 수 있다.
- 다만, 효율성 면에서 좋은 구조는 아니므로 적절히 사용해야한다.